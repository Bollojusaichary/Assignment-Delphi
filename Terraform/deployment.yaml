# azure-pipelines.yml
# Production Terraform Deployment Pipeline for UAE North
# Provisions: Resource Group → ACR → AKS → Key Vault → App Service

trigger:
  branches:
    include:
      - main
      - master

pr:
  branches:
    include:
      - main
      - master

variables:
  - name: azureSubscription          # Service connection name (create below)
    value: 'azure-prod-spn-connection'  
  - name: storageAccountName
    value: 'tfstateprod$(Build.BuildId)'   # Make unique per project
  - name: containerName
    value: 'tfstate'
  - name: key
    value: 'prod-terraform.tfstate'
  - name: resourceGroupState
    value: 'rg-tfstate-prod'
  - name: location
    value: 'uaenorth'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Validate
  displayName: 'Validate Terraform Code'
  jobs:
  - job: TerraformValidate
    displayName: 'Terraform Validate'
    steps:
    - task: TerraformInstaller@0
      inputs:
        terraformVersion: 'latest'

    - script: |
        terraform init -backend=false
        terraform validate
        terraform fmt -check -recursive
      displayName: 'Terraform Init (no backend) + Validate + Format Check'

- stage: Plan
  displayName: 'Terraform Plan'
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - job: TerraformPlan
    displayName: 'Terraform Plan'
    steps:
    - task: TerraformInstaller@0
      inputs:
        terraformVersion: 'latest'

    - script: |
        terraform init \
          -backend-config="storage_account_name=$(storageAccountName)" \
          -backend-config="container_name=$(containerName)" \
          -backend-config="key=$(key)" \
          -backend-config="resource_group_name=$(resourceGroupState)"

        terraform plan -out=tfplan -var-file=terraform.tfvars
      displayName: 'Terraform Init + Plan'
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/tfplan'
        artifact: 'tfplan'
        publishLocation: 'pipeline'
      displayName: 'Publish Terraform Plan'

- stage: Apply
  displayName: 'Terraform Apply - Production'
  dependsOn: Plan
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: 'Deploy to Production'
    environment: 'production'   # Requires manual approval if you set it up
    strategy:
      runOnce:
        deploy:
          steps:
          - task: TerraformInstaller@0
            inputs:
              terraformVersion: 'latest'

          - download: current
            artifact: 'tfplan'

          - script: |
              terraform init \
                -backend-config="storage_account_name=$(storageAccountName)" \
                -backend-config="container_name=$(containerName)" \
                -backend-config="key=$(key)" \
                -backend-config="resource_group_name=$(resourceGroupState)"

              terraform apply -auto-approve tfplan
            displayName: 'Terraform Apply'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

          - script: |
              echo "Deployment completed successfully!"
              echo "AKS Cluster: https://portal.azure.com/#resource/$(terraform output -raw aks_cluster_id)"
            displayName: 'Show Success Links'